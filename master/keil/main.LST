C51 COMPILER V9.52.0.0   MAIN                                                              03/21/2019 13:56:27 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          #include <reg51.h>      //头文件
   2          
   3          
   4          //倒计时
   5          unsigned char buf[4];             //片选数码管变量
   6          unsigned int EW_time_default = 15;      //东西默认值
   7          unsigned int SN_time_default = 15;      //南北默认值
   8          unsigned int EW_time_now = 15;    //东西方向当前数秒
   9          unsigned int SN_time_now = 15;    //南北方向当前数秒
  10          
  11          //通行
  12          unsigned int SN_or_EW = 1; //0：南北通行 1：东西通行
  13          unsigned int Open = 1;
  14          unsigned int SN_flash = 0; //南北黄灯闪烁标志
  15          unsigned int EW_flash = 0; //东西黄灯闪烁标志
  16          
  17          //字型码
  18          unsigned char code LED[] = {0xc0, 0xf9, 0xa4, 0xb0, 0x99, 0x92, 0x82, 0xf8, 0x80, 0x90};
  19          
  20          
  21          //计数
  22          unsigned int time0_count; //1s定时
  23          unsigned int flash_count; //0.5s定时
  24          unsigned int flash_signl; //闪烁计数信号
  25          
  26          //红绿灯
  27          sbit Green_EW = P2 ^ 1;   //东西
  28          sbit Yellow_EW = P2 ^ 2;
  29          sbit Red_EW = P2 ^ 3;
  30          
  31          sbit Red_SN = P2 ^ 6;   //南北
  32          sbit Yellow_SN = P2 ^ 5;
  33          sbit Green_SN = P2 ^ 4;
  34          
  35          //函数声明
  36          void delay(int ms);     //延时
  37          void display();       //显示倒计时
  38          void init();          //开机初始化
  39          void Timer0Init();       //定时器0
  40          void traffic_light(); //控制信号灯
  41          void LED_light();      //控制倒计时
  42          void flash();         //黄灯闪烁
  43          
  44          void main()
  45          {
  46   1          init();
  47   1          while (1) {
  48   2              display();
  49   2          }
  50   1      }
  51          
  52          void init()
  53          {
  54   1          //开总中断
  55   1          EA = 1;
C51 COMPILER V9.52.0.0   MAIN                                                              03/21/2019 13:56:27 PAGE 2   

  56   1          //外部中断
  57   1          IT0=1; //跳变沿
  58   1          EX0=1;//中断允许
  59   1          IT1=1; //跳变沿
  60   1          EX1=1;//中断允许
  61   1        
  62   1          ET0 = 1;      //开定时器0
  63   1          //定时器0初始化
  64   1          Timer0Init();
  65   1      }
  66          
  67          void time0() interrupt 1
  68          {
  69   1          //重置定时器
  70   1          TH0 = 0x4c;
  71   1          TL0 = 0x00;
  72   1          //调整信号灯
  73   1          traffic_light();
  74   1          //调整倒计时
  75   1          LED_light();
  76   1          //调整黄灯
  77   1          flash();
  78   1      }
  79          
  80          void display() //显示子程序
  81          {
  82   1      
  83   1      
  84   1      
  85   1          //南北方向个位十位
  86   1          buf[0] = SN_time_now / 10;
  87   1          buf[1] = SN_time_now % 10;
  88   1          //东西方向个位十位
  89   1          buf[2] = EW_time_now / 10;
  90   1          buf[3] = EW_time_now % 10;
  91   1      
  92   1          //点亮南北方向倒计时
  93   1          P1 = 0x01;              //片选LED1
  94   1          P0 = LED[buf[0]];     //送南北时间十位的数码管编码
  95   1          delay(1);       //延时
  96   1      
  97   1          P1 = 0x02;              //片选LED2
  98   1          P0 = LED[buf[1]];
  99   1          delay(1);
 100   1      
 101   1          P1 = 0X04;          //片选LED3
 102   1          P0 = LED[buf[2]];       //送东西时间十位的数码管编码
 103   1          delay(1);       //延时
 104   1      
 105   1          P1 = 0X08;        //片选LED4
 106   1          P0 = LED[buf[3]];
 107   1          delay(1);
 108   1      }
 109          
 110          void traffic_light() //信号灯
 111          {
 112   1          //
 113   1          if((SN_or_EW)) {
 114   2              //东西方向通行  绿灯亮
 115   2              if(EW_time_now > 5) {
 116   3                  Green_EW = Open;    //小于5s时，黄灯闪烁
 117   3                  EW_flash = !Open;
C51 COMPILER V9.52.0.0   MAIN                                                              03/21/2019 13:56:27 PAGE 3   

 118   3              } else {
 119   3                  Green_EW = !Open;
 120   3                  EW_flash = Open;
 121   3              }
 122   2              Red_EW = !Open;
 123   2              //南北方向进禁行 红灯亮
 124   2              SN_flash = !Open; //关闭黄灯
 125   2              Green_SN = !Open;
 126   2              Red_SN = Open;
 127   2          } else {
 128   2              //东西方向禁行  红灯亮
 129   2              EW_flash = !Open; //关闭黄灯
 130   2              Green_EW = !Open;
 131   2              Red_EW = Open;
 132   2              //南北方向通行新痰屏
 133   2              if(SN_time_now > 5) {
 134   3                  Green_SN = Open;    //小于5s时，黄灯闪烁
 135   3                  SN_flash = !Open;
 136   3              } else {
 137   3                  Green_SN = !Open;
 138   3                  SN_flash = Open;
 139   3              }
 140   2              Red_SN = !Open;
 141   2          }
 142   1      }
 143          
 144          void flash()
 145          {
 146   1          flash_count++;
 147   1          if(flash_count >= 10) { //0.5s闪烁一次
 148   2              flash_count = 0;
 149   2              flash_signl++;
 150   2              if(flash_signl > 10)
 151   2                  flash_signl = 0; //闪烁信号清零
 152   2      
 153   2              //黄灯闪烁
 154   2              if(SN_flash) {
 155   3                  Yellow_SN = flash_signl % 2;
 156   3              } else {
 157   3                  Yellow_SN = !Open;
 158   3              }
 159   2              if(EW_flash) {
 160   3                  Yellow_EW = flash_signl % 2;
 161   3              } else {
 162   3                  Yellow_EW = !Open;
 163   3              }
 164   2          }
 165   1      }
 166          
 167          void LED_light() //倒计时
 168          {
 169   1          time0_count++;
 170   1          if(time0_count >= 20) {
 171   2              //每秒检测一次，归零后重置，并切换通行方向
 172   2              time0_count = 0;
 173   2              //东西通行
 174   2              if(SN_or_EW) {
 175   3                  if(EW_time_now > 0) {
 176   4                      EW_time_now--;
 177   4                      if(SN_time_now > 0) {
 178   5                          SN_time_now--;
 179   5                      } else {
C51 COMPILER V9.52.0.0   MAIN                                                              03/21/2019 13:56:27 PAGE 4   

 180   5                          SN_time_now = EW_time_now;
 181   5                      }
 182   4                  } else {
 183   4                      EW_time_now=EW_time_default;
 184   4                      SN_time_now=SN_time_default;
 185   4                      SN_or_EW = !SN_or_EW;
 186   4                  }
 187   3              }
 188   2              //南北通行
 189   2              else {
 190   3                  if(SN_time_now > 0) {
 191   4                      SN_time_now--;
 192   4                      if(EW_time_now > 0) {
 193   5                          EW_time_now--;
 194   5                      } else {
 195   5                          EW_time_now = SN_time_now;
 196   5                      }
 197   4                  } else {
 198   4                      EW_time_now=EW_time_default;
 199   4                      SN_time_now=SN_time_default;
 200   4                      SN_or_EW = !SN_or_EW;
 201   4                  }
 202   3              }
 203   2          }
 204   1      }
 205          
 206          void delay(int ms)      //延时子程序
 207          {
 208   1          unsigned int j, k;
 209   1          for (j = 0; j < ms; j++)
 210   1              for (k = 0; k < 124; k++)
 211   1                  ;
 212   1      }
 213          
 214          void Timer0Init()   //50毫秒@11.0592MHz
 215          {
 216   1          TMOD = 0x01;  //设置定时器模式
 217   1          TL0 = 0x00;   //设置定时初值
 218   1          TH0 = 0x4C;   //设置定时初值
 219   1          TF0 = 0;      //清除TF0标志
 220   1          TR0 = 1;      //定时器0开始计时
 221   1      }
 222          
 223          void sensor1() interrupt 0
 224          {
 225   1        delay(100);//延时消抖
 226   1        SN_time_now+=5;
 227   1      }
 228          
 229          void sensor2() interrupt 2
 230          {
 231   1        delay(100);//延时消抖
 232   1        EW_time_now+=5;
 233   1      }
 234          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    819    ----
   CONSTANT SIZE    =     10    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
C51 COMPILER V9.52.0.0   MAIN                                                              03/21/2019 13:56:27 PAGE 5   

   DATA SIZE        =     26    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
